<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator V2</title>
    <style>
        body {
            background-color: #0f172a; color: #f8fafc;
            font-family: sans-serif; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; margin: 0; padding: 20px;
        }
        .container {
            width: 100%; max-width: 600px; background: #1e293b;
            padding: 2rem; border-radius: 12px;
        }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; }
        button { padding: 12px 24px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background: #475569; }
        .status { margin-top: 10px; color: #94a3b8; font-style: italic; }
        .gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        img { width: 100%; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üöÄ AI Text to Image V2</h1>
    <div class="container">
        <div class="input-group">
            <input type="text" id="promptInput" placeholder="Contoh: A flying cat in space..." />
            <button id="generateBtn" onclick="startGeneration()">Buat Gambar</button>
        </div>
        <div class="status" id="statusText">Siap membuat gambar.</div>
        <div class="gallery" id="gallery"></div>
    </div>

    <script>
        async function startGeneration() {
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('statusText');
            const gallery = document.getElementById('gallery');

            if (!prompt) return alert("Isi prompt dulu!");

            btn.disabled = true;
            gallery.innerHTML = "";
            status.innerText = "‚è≥ Sedang menghubungi server...";

            try {
                // 1. Request Start
                const startRes = await fetch('/api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const startData = await startRes.json();

                if (!startData.success) throw new Error(startData.error);

                const { taskId, session } = startData;
                status.innerText = "üî® AI sedang bekerja... (0s)";

                // 2. Polling Status (Looping di Client)
                let attempts = 0;
                const interval = setInterval(async () => {
                    attempts++;
                    status.innerText = `üî® AI sedang bekerja... (${attempts * 2}s)`;

                    try {
                        const checkRes = await fetch('/api/check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ taskId, session })
                        });
                        const checkData = await checkRes.json();

                        if (checkData.state === 'completed') {
                            clearInterval(interval);
                            status.innerText = "‚úÖ Selesai!";
                            btn.disabled = false;
                            
                            checkData.images.forEach(url => {
                                const img = document.createElement('img');
                                img.src = url;
                                gallery.appendChild(img);
                            });
                        } else if (checkData.state === 'failed') {
                            clearInterval(interval);
                            status.innerText = "‚ùå Gagal membuat gambar.";
                            btn.disabled = false;
                        }
                        
                        // Stop jika lebih dari 60 detik
                        if (attempts > 30) {
                            clearInterval(interval);
                            status.innerText = "‚ö†Ô∏è Timeout: Terlalu lama.";
                            btn.disabled = false;
                        }

                    } catch (e) {
                        console.error(e);
                        // Jangan stop interval kalau error koneksi sesaat
                    }
                }, 2000); // Cek setiap 2 detik

            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå Error: " + err.message;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
